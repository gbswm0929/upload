<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë™ì˜ìƒ ì—…ë¡œë“œ</title>
  <style>
    body { font-family: sans-serif; margin: 40px; }
    .video-item { cursor: pointer; color: blue; text-decoration: underline; margin: 4px 0; }
    #progressContainer {
      margin-top: 20px;
      display: none;
      width: 100%;
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
      height: 20px;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background: #4CAF50;
      text-align: center;
      color: white;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>ğŸ¬ ë™ì˜ìƒ ì—…ë¡œë“œ</h1>

  <form id="uploadForm">
    <input type="file" name="video" accept="video/*" required>
    <button type="submit">ì—…ë¡œë“œ</button>
  </form>

  <!-- ì—…ë¡œë“œ ì§„í–‰ë¥  -->
  <div id="progressContainer">
    <div id="progressBar">0%</div>
  </div>

  <hr>

  <h2>ì—…ë¡œë“œëœ ë™ì˜ìƒ ëª©ë¡</h2>
  <div id="videoList"></div>

  <script>
    // ì—…ë¡œë“œ ì§„í–‰ í‘œì‹œ ê¸°ëŠ¥
    const form = document.getElementById("uploadForm");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const fileInput = form.querySelector("input[name='video']");
      if (!fileInput.files.length) return alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!");

      const formData = new FormData();
      formData.append("video", fileInput.files[0]);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/upload", true);

      // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
      xhr.upload.onprogress = function (event) {
        if (event.lengthComputable) {
          const percent = Math.round((event.loaded / event.total) * 100);
          progressContainer.style.display = "block";
          progressBar.style.width = percent + "%";
          progressBar.textContent = percent + "%";
        }
      };

      // ì—…ë¡œë“œ ì™„ë£Œ í›„
      xhr.onload = function () {
        if (xhr.status === 200) {
          progressBar.textContent = "ì™„ë£Œ!";
          setTimeout(() => {
            progressContainer.style.display = "none";
            progressBar.style.width = "0%";
            loadVideos();
            fileInput.value = "";
          }, 1000);
        } else {
          alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + xhr.responseText);
        }
      };

      xhr.send(formData);
    });

    // // ì—…ë¡œë“œëœ ì˜ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    // async function loadVideos() {
    //   const res = await fetch("/list");
    //   const videos = await res.json();
    //   const listDiv = document.getElementById("videoList");
    //   listDiv.innerHTML = "";

    //   videos.forEach((v) => {
    //     const link = document.createElement("div");
    //     link.textContent = v.name;
    //     link.className = "video-item";
    //     link.onclick = () => window.open(v.url, "_blank");
    //     listDiv.appendChild(link);
    //   });
    // }

    // loadVideos();


    async function loadVideos() {
      const res = await fetch("/list");
      const videos = await res.json();
      const listDiv = document.getElementById("videoList");
      listDiv.innerHTML = "";

      videos.forEach((v) => {
        const link = document.createElement("a");
        link.href = v.url;
        link.textContent = v.name;
        link.target = "_blank"; // ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
        link.style.display = "block";
        link.style.margin = "4px 0";
        listDiv.appendChild(link);
      });
    }
    loadVideos();
  </script>
</body>
</html>
